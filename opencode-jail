#!/usr/bin/env bash
# opencode-jail - Run OpenCode inside a bubblewrap sandbox
#
# Usage:
#   opencode-jail [PROJECT_DIR] [-- opencode args...]
#
# Examples:
#   opencode-jail                          # sandbox no diretorio atual
#   opencode-jail /path/to/project         # sandbox em projeto especifico
#   opencode-jail . -- run "Hello"         # passa args para opencode
#   opencode-jail --dry-run                # mostra o comando sem executar
#
# O sandbox:
#   - Monta o sistema de arquivos como read-only (exceto o projeto)
#   - Projeto montado com read-write
#   - Acesso total a internet (compartilha network namespace)
#   - Carrega configs do OpenCode (~/.config/opencode, ~/.local/share/opencode, etc.)
#   - Carrega credenciais de providers (env vars de API keys)
#   - Carrega certificados SSL, DNS, git config
#   - /tmp e /dev isolados
#   - Sem acesso ao restante do home do usuario

set -euo pipefail

# ---------------------------------------------------------------------------
# Cores e helpers
# ---------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RESET='\033[0m'

info()  { printf "${CYAN}[jail]${RESET} %s\n" "$*"; }
warn()  { printf "${YELLOW}[jail]${RESET} %s\n" "$*"; }
error() { printf "${RED}[jail]${RESET} %s\n" "$*" >&2; }
ok()    { printf "${GREEN}[jail]${RESET} %s\n" "$*"; }

# ---------------------------------------------------------------------------
# Dependencias
# ---------------------------------------------------------------------------
for cmd in bwrap opencode; do
    if ! command -v "$cmd" &>/dev/null; then
        error "Comando '$cmd' nao encontrado. Instale antes de continuar."
        exit 1
    fi
done

# ---------------------------------------------------------------------------
# Argumentos
# ---------------------------------------------------------------------------
DRY_RUN=false
PROJECT_DIR=""
OPENCODE_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --help|-h)
            sed -n '2,/^$/s/^# \?//p' "$0"
            exit 0
            ;;
        --)
            shift
            OPENCODE_ARGS=("$@")
            break
            ;;
        *)
            if [[ -z "$PROJECT_DIR" ]]; then
                PROJECT_DIR="$1"
            else
                OPENCODE_ARGS+=("$1")
            fi
            shift
            ;;
    esac
done

# Default: diretorio atual
PROJECT_DIR="${PROJECT_DIR:-.}"
PROJECT_DIR="$(realpath "$PROJECT_DIR")"

if [[ ! -d "$PROJECT_DIR" ]]; then
    error "Diretorio do projeto nao existe: $PROJECT_DIR"
    exit 1
fi

info "Projeto: $PROJECT_DIR"

# ---------------------------------------------------------------------------
# Detectar paths
# ---------------------------------------------------------------------------
OPENCODE_BIN="$(command -v opencode)"
HOME_DIR="$HOME"
USER_NAME="$(whoami)"
USER_ID="$(id -u)"
GROUP_ID="$(id -g)"
SHELL_BIN="${SHELL:-/usr/bin/bash}"

# Configs do OpenCode
OPENCODE_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME_DIR/.config}/opencode"
OPENCODE_DATA_DIR="${XDG_DATA_HOME:-$HOME_DIR/.local/share}/opencode"
OPENCODE_CACHE_DIR="${XDG_CACHE_HOME:-$HOME_DIR/.cache}/opencode"
OPENCODE_STATE_DIR="${XDG_STATE_HOME:-$HOME_DIR/.local/state}/opencode"

# Git config
GIT_CONFIG_GLOBAL="${HOME_DIR}/.gitconfig"
GIT_CONFIG_SYSTEM="/etc/gitconfig"

# ---------------------------------------------------------------------------
# Construir argumentos do bwrap
# ---------------------------------------------------------------------------
BWRAP_ARGS=()

# --- Filesystem base (read-only) ---
# Montar as partes essenciais do sistema como ro
BWRAP_ARGS+=(--ro-bind /usr /usr)

# /lib e /lib64 podem ser symlinks para usr/lib em distros modernas
if [[ -L /lib ]]; then
    BWRAP_ARGS+=(--symlink usr/lib /lib)
else
    BWRAP_ARGS+=(--ro-bind /lib /lib)
fi

if [[ -L /lib64 ]]; then
    BWRAP_ARGS+=(--symlink usr/lib /lib64)
else
    BWRAP_ARGS+=(--ro-bind /lib64 /lib64)
fi

# /bin e /sbin podem ser symlinks para usr/bin em distros modernas
if [[ -L /bin ]]; then
    BWRAP_ARGS+=(--symlink usr/bin /bin)
else
    BWRAP_ARGS+=(--ro-bind /bin /bin)
fi

if [[ -L /sbin ]]; then
    BWRAP_ARGS+=(--symlink usr/bin /sbin)
else
    BWRAP_ARGS+=(--ro-bind /sbin /sbin)
fi

# /etc - necessario para DNS, SSL, nsswitch, etc
BWRAP_ARGS+=(--ro-bind /etc /etc)

# --- proc, dev, tmp ---
BWRAP_ARGS+=(
    --proc /proc
    --dev /dev
    --tmpfs /tmp
    --tmpfs /run
)

# Resolver DNS via systemd-resolved (se aplicavel)
if [[ -d /run/systemd/resolve ]]; then
    BWRAP_ARGS+=(--ro-bind /run/systemd/resolve /run/systemd/resolve)
fi

# --- Network: compartilhar namespace de rede (acesso a internet) ---
BWRAP_ARGS+=(--share-net)

# --- Home minimo ---
# Criar um home limpo dentro do sandbox
BWRAP_ARGS+=(--tmpfs "$HOME_DIR")

# --- Projeto: montado read-write ---
BWRAP_ARGS+=(--bind "$PROJECT_DIR" "$PROJECT_DIR")

# --- Configuracoes do OpenCode ---
# Config dir (~/.config/opencode) - rw para poder salvar configs
if [[ -d "$OPENCODE_CONFIG_DIR" ]]; then
    BWRAP_ARGS+=(--bind "$OPENCODE_CONFIG_DIR" "$OPENCODE_CONFIG_DIR")
    info "Config: $OPENCODE_CONFIG_DIR"
fi

# Data dir (~/.local/share/opencode) - rw para auth, storage, logs
if [[ -d "$OPENCODE_DATA_DIR" ]]; then
    BWRAP_ARGS+=(--bind "$OPENCODE_DATA_DIR" "$OPENCODE_DATA_DIR")
    info "Data: $OPENCODE_DATA_DIR"
else
    # Criar se nao existir, opencode precisa disso
    mkdir -p "$OPENCODE_DATA_DIR"
    BWRAP_ARGS+=(--bind "$OPENCODE_DATA_DIR" "$OPENCODE_DATA_DIR")
    info "Data (criado): $OPENCODE_DATA_DIR"
fi

# Garantir que o parent dir de data existe dentro do sandbox
BWRAP_ARGS+=(
    --dir "$(dirname "$OPENCODE_DATA_DIR")"
    --dir "$(dirname "$(dirname "$OPENCODE_DATA_DIR")")"
)

# Garantir que o parent dir de config existe dentro do sandbox
BWRAP_ARGS+=(
    --dir "$(dirname "$OPENCODE_CONFIG_DIR")"
)

# Cache dir (~/.cache/opencode) - rw para models.json, etc
if [[ -d "$OPENCODE_CACHE_DIR" ]]; then
    BWRAP_ARGS+=(--bind "$OPENCODE_CACHE_DIR" "$OPENCODE_CACHE_DIR")
    info "Cache: $OPENCODE_CACHE_DIR"
else
    mkdir -p "$OPENCODE_CACHE_DIR"
    BWRAP_ARGS+=(--bind "$OPENCODE_CACHE_DIR" "$OPENCODE_CACHE_DIR")
fi

# Garantir que parent dir de cache existe
BWRAP_ARGS+=(
    --dir "$(dirname "$OPENCODE_CACHE_DIR")"
)

# State dir (~/.local/state/opencode) - rw
if [[ -d "$OPENCODE_STATE_DIR" ]]; then
    BWRAP_ARGS+=(--bind "$OPENCODE_STATE_DIR" "$OPENCODE_STATE_DIR")
fi

# --- .opencode no projeto (se existir) ---
if [[ -d "$PROJECT_DIR/.opencode" ]]; then
    info "Project .opencode dir detectado"
fi

# --- opencode.json no projeto (se existir) ---
if [[ -f "$PROJECT_DIR/opencode.json" || -f "$PROJECT_DIR/opencode.jsonc" ]]; then
    info "Project opencode config detectado"
fi

# --- Git config (read-only) ---
if [[ -f "$GIT_CONFIG_GLOBAL" ]]; then
    BWRAP_ARGS+=(--ro-bind "$GIT_CONFIG_GLOBAL" "$GIT_CONFIG_GLOBAL")
    info "Git config: $GIT_CONFIG_GLOBAL"
fi

if [[ -f "$GIT_CONFIG_SYSTEM" ]]; then
    BWRAP_ARGS+=(--ro-bind "$GIT_CONFIG_SYSTEM" "$GIT_CONFIG_SYSTEM")
fi

# --- SSH keys (read-only, para git operations) ---
if [[ -d "$HOME_DIR/.ssh" ]]; then
    BWRAP_ARGS+=(--ro-bind "$HOME_DIR/.ssh" "$HOME_DIR/.ssh")
    info "SSH keys: montados (ro)"
fi

# --- mise/asdf/nvm runtimes (read-only) ---
# mise
if [[ -d "$HOME_DIR/.local/share/mise" ]]; then
    BWRAP_ARGS+=(--ro-bind "$HOME_DIR/.local/share/mise" "$HOME_DIR/.local/share/mise")
    info "Mise runtimes: montados (ro)"
fi

# mise config
if [[ -d "${XDG_CONFIG_HOME:-$HOME_DIR/.config}/mise" ]]; then
    BWRAP_ARGS+=(--ro-bind "${XDG_CONFIG_HOME:-$HOME_DIR/.config}/mise" "${XDG_CONFIG_HOME:-$HOME_DIR/.config}/mise")
fi

# nvm
if [[ -d "$HOME_DIR/.nvm" ]]; then
    BWRAP_ARGS+=(--ro-bind "$HOME_DIR/.nvm" "$HOME_DIR/.nvm")
    info "NVM runtimes: montados (ro)"
fi

# --- Variaveis de ambiente ---
# Preservar variaveis essenciais
BWRAP_ARGS+=(
    --setenv HOME "$HOME_DIR"
    --setenv USER "$USER_NAME"
    --setenv SHELL "$SHELL_BIN"
    --setenv TERM "${TERM:-xterm-256color}"
    --setenv LANG "${LANG:-en_US.UTF-8}"
    --setenv PATH "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$HOME_DIR/.local/bin:$HOME_DIR/.local/share/mise/shims"
)

# COLORTERM para suporte a cores no terminal
if [[ -n "${COLORTERM:-}" ]]; then
    BWRAP_ARGS+=(--setenv COLORTERM "$COLORTERM")
fi

# XDG dirs
BWRAP_ARGS+=(
    --setenv XDG_CONFIG_HOME "${XDG_CONFIG_HOME:-$HOME_DIR/.config}"
    --setenv XDG_DATA_HOME "${XDG_DATA_HOME:-$HOME_DIR/.local/share}"
    --setenv XDG_CACHE_HOME "${XDG_CACHE_HOME:-$HOME_DIR/.cache}"
    --setenv XDG_STATE_HOME "${XDG_STATE_HOME:-$HOME_DIR/.local/state}"
)

# --- API Keys / Provider credentials ---
# Propagar todas as env vars de providers conhecidos
ENV_PATTERNS=(
    "ANTHROPIC_API_KEY"
    "OPENAI_API_KEY"
    "GOOGLE_API_KEY"
    "GEMINI_API_KEY"
    "MISTRAL_API_KEY"
    "GROQ_API_KEY"
    "XAI_API_KEY"
    "DEEPSEEK_API_KEY"
    "TOGETHER_API_KEY"
    "FIREWORKS_API_KEY"
    "COHERE_API_KEY"
    "PERPLEXITY_API_KEY"
    "OPENROUTER_API_KEY"
    "AZURE_OPENAI_API_KEY"
    "AZURE_OPENAI_ENDPOINT"
    "AWS_ACCESS_KEY_ID"
    "AWS_SECRET_ACCESS_KEY"
    "AWS_SESSION_TOKEN"
    "AWS_REGION"
    "AWS_PROFILE"
    "AWS_BEARER_TOKEN_BEDROCK"
    "GITHUB_TOKEN"
    "GITLAB_TOKEN"
    "OPENCODE"
    "OPENCODE_API_KEY"
    "OPENCODE_MODEL"
    "OPENCODE_CONFIG"
    "OPENCODE_CONFIG_DIR"
    "OPENCODE_CONFIG_CONTENT"
)

for var in "${ENV_PATTERNS[@]}"; do
    if [[ -n "${!var:-}" ]]; then
        BWRAP_ARGS+=(--setenv "$var" "${!var}")
    fi
done

# Propagar qualquer env var que comece com OPENCODE_
while IFS='=' read -r key value; do
    if [[ "$key" == OPENCODE_* && ! " ${ENV_PATTERNS[*]} " =~ " $key " ]]; then
        BWRAP_ARGS+=(--setenv "$key" "$value")
    fi
done < <(env)

# --- Identidade ---
BWRAP_ARGS+=(
    --uid "$USER_ID"
    --gid "$GROUP_ID"
)

# --- Terminal interativo ---
BWRAP_ARGS+=(
    --dev-bind /dev/pts /dev/pts
    --dev-bind /dev/ptmx /dev/ptmx
)

# Manter stdin como terminal
if [[ -t 0 ]]; then
    BWRAP_ARGS+=(--dev-bind /dev/tty /dev/tty)
fi

# --- Working directory ---
BWRAP_ARGS+=(
    --chdir "$PROJECT_DIR"
)

# --- Die with parent ---
BWRAP_ARGS+=(--die-with-parent)

# ---------------------------------------------------------------------------
# Executar
# ---------------------------------------------------------------------------
FULL_CMD=(bwrap "${BWRAP_ARGS[@]}" -- "$OPENCODE_BIN" "${OPENCODE_ARGS[@]}")

if [[ "$DRY_RUN" == true ]]; then
    warn "Dry run - comando que seria executado:"
    echo ""
    # Pretty-print: group bwrap flag + its arguments on one line
    local_cmd=("${FULL_CMD[@]}")
    i=0
    line=""
    while [[ $i -lt ${#local_cmd[@]} ]]; do
        token="${local_cmd[$i]}"
        if [[ "$token" == "bwrap" ]]; then
            printf 'bwrap \\\n'
        elif [[ "$token" == "--" ]]; then
            printf '  -- '
            # Print rest of command
            i=$((i + 1))
            printf '%s' "${local_cmd[*]:$i}"
            echo ""
            break
        elif [[ "$token" == --* ]]; then
            # Count how many non-flag args follow
            j=$((i + 1))
            args=()
            while [[ $j -lt ${#local_cmd[@]} && "${local_cmd[$j]}" != --* ]]; do
                args+=("${local_cmd[$j]}")
                j=$((j + 1))
            done
            printf '  %s %s \\\n' "$token" "${args[*]}"
            i=$((j - 1))
        fi
        i=$((i + 1))
    done
    echo ""
    exit 0
fi

ok "Iniciando OpenCode em sandbox..."
info "Network: compartilhada (acesso a internet)"
info "Projeto (rw): $PROJECT_DIR"
info "Sistema (ro): /usr, /lib, /etc, /bin, /sbin"
echo ""

exec "${FULL_CMD[@]}"
